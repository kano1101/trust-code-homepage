# 03. wp-config.php の修正（環境変数の確実な適用）

## 問題

WordPress の `WORDPRESS_CONFIG_EXTRA` 環境変数が Docker Compose から正しく渡っていない可能性がある。または、WordPress が起動する前に URL が生成されている可能性がある。

## 解決策

`docker-entrypoint-wrapper.sh` または `init-wordpress.sh` で、wp-config.php に直接 URL 設定を書き込む。

## 修正内容

### wordpress/init-wordpress.sh に追加

wp-config.php が生成された直後に、URL 設定を確実に書き込む：

```bash
# wp-config.php に URL 設定を追加（WP_HOME, WP_SITEURL より優先）
if [ -f /var/www/html/wp-config.php ]; then
  echo "Ensuring URL settings in wp-config.php..."

  # 既存の WP_HOME, WP_SITEURL 定義を削除
  sed -i '/define.*WP_HOME/d' /var/www/html/wp-config.php
  sed -i '/define.*WP_SITEURL/d' /var/www/html/wp-config.php

  # 環境変数から取得
  WP_HOME_URL="${WP_HOME:-https://trust-code.net}"
  WP_SITEURL_URL="${WP_SITEURL:-https://trust-code.net}"

  # wp-config.php の最初の <?php の後に挿入
  sed -i "2i\\
// URL Settings (Auto-generated by init-wordpress.sh)\\
define('WP_HOME', '$WP_HOME_URL');\\
define('WP_SITEURL', '$WP_SITEURL_URL');\\
\\
// Force HTTPS for admin\\
if (strpos('$WP_HOME_URL', 'https://') === 0) {\\
  define('FORCE_SSL_ADMIN', true);\\
  \$_SERVER['HTTPS'] = 'on';\\
  if (!empty(\$_SERVER['HTTP_X_FORWARDED_PROTO']) && \$_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {\\
    \$_SERVER['SERVER_PORT'] = 443;\\
  }\\
}
" /var/www/html/wp-config.php

  echo "URL settings written to wp-config.php"
fi
```

## 実装手順

### 1. init-wordpress.sh を修正

ファイル: `/Users/akirakano/IdeaProjects/homepage/wordpress/init-wordpress.sh`

### 2. 開発環境でテスト

```bash
# Docker Compose を再起動
cd /Users/akirakano/IdeaProjects/homepage
docker compose down
docker compose up -d --build

# wp-config.php の内容を確認
docker compose exec wordpress cat /var/www/html/wp-config.php | head -30

# 診断スクリプトで確認
docker compose exec wordpress php /var/www/html/wp-content/themes/readdy-theme4/diagnostic.php
```

### 3. 本番環境にデプロイ

```bash
cd /Users/akirakano/IdeaProjects/homepage/wordpress/themes/readdy-theme4
./deploy-prod.sh
```

## チェックポイント

- [ ] init-wordpress.sh を修正
- [ ] 開発環境で Docker イメージを再ビルド
- [ ] wp-config.php に WP_HOME, WP_SITEURL が書き込まれているか確認
- [ ] 診断スクリプトで確認
- [ ] 本番環境にデプロイ
- [ ] 本番環境で動作確認

## 期待される結果

wp-config.php の先頭付近に以下が追加される:

```php
<?php
// URL Settings (Auto-generated by init-wordpress.sh)
define('WP_HOME', 'https://trust-code.net');
define('WP_SITEURL', 'https://trust-code.net');

// Force HTTPS for admin
if (strpos('https://trust-code.net', 'https://') === 0) {
  define('FORCE_SSL_ADMIN', true);
  $_SERVER['HTTPS'] = 'on';
  if (!empty($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
    $_SERVER['SERVER_PORT'] = 443;
  }
}
```

## 次のステップ

04-fix-htaccess.md で .htaccess の確認と修正を行う。

## ステータス

- [ ] init-wordpress.sh 修正完了
- [ ] 開発環境でテスト完了
- [ ] 本番環境デプロイ完了
- [ ] 動作確認完了
